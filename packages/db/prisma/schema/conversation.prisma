model Conversation {
  id                 String    @id @default(uuid())
  tenantId           String
  channel            String
  instanceId         String
  contactId          String
  status             String    @default("OPEN")
  stage              String    @default("LEAD")
  isActive           Boolean   @default(true)
  assignedAgentId    String?
  openedAt           DateTime
  lastMessageAt      DateTime
  lastInboundAt      DateTime?
  lastOutboundAt     DateTime?
  unreadCount        Int       @default(0)
  metadata           Json?
  firstResponseDueAt DateTime?
  nextResponseDueAt  DateTime?
  slaBreachedAt      DateTime?
  leadId         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]
  lead Lead? @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@unique([instanceId, contactId, isActive])
  @@index([tenantId, instanceId, contactId])
  @@index([isActive, firstResponseDueAt])
  @@index([isActive, nextResponseDueAt])
  @@index([tenantId, leadId])
  @@map("conversation")
}

model Message {
  id                String   @id @default(uuid())
  conversationId    String
  direction         String
  type              String
  sentBy            String
  providerMessageId String?
  contentRef        String?
  metadata          Json?
  occurredAt        DateTime

  createdAt DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, providerMessageId])
  @@index([conversationId, occurredAt])
  @@map("message")
}
