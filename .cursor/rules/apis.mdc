---
alwaysApply: true
---
# WhatLead API Documentation - Version: 1.0.0

## Purpose & Scope

This document serves as the central repository for documentation on all API endpoints within the WhatLead application. It provides details on endpoint paths, HTTP methods, purpose, request/response formats, and authentication requirements.

**MUST** be consulted and updated whenever API endpoints are created, modified, or deleted, as mandated by `@memory.mdc`.

## API Endpoint Example

---

### `[HTTP_METHOD] /path/to/endpoint`

*   **Purpose:** [Briefly describe what the endpoint does.]
*   **Authentication:** [Specify required authentication (e.g., Better Auth session, Public, None, Admin Role).] 
*   **Request Parameters (URL/Query):**
    *   `paramName` (type): [Description, e.g., required, optional, validation rules].
*   **Request Body (JSON):**
    ```json
    {
      "key": "value_type" // Description
    }
    ```
*   **Success Response (200 OK):**
    ```json
    {
      "key": "value_type" // Description
    }
    ```
*   **Error Responses:**
    *   `400 Bad Request`: [Reason, e.g., Invalid input data.]
    *   `401 Unauthorized`: [Reason, e.g., Missing or invalid authentication token.]
    *   `403 Forbidden`: [Reason, e.g., Insufficient permissions.]
    *   `404 Not Found`: [Reason, e.g., Resource not found.]
    *   `500 Internal Server Error`: [Reason, e.g., Unexpected server error.]
*   **Notes:** [Any additional information, implementation details, or usage notes.]

---

## API Endpoints

### Campanhas (Campaigns)

#### `campaign.list` (tRPC Query)

* **Purpose:** Lista todas as campanhas do usuário autenticado.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):** Nenhum.
* **Success Response (200 OK):**
  ```json
  [
    {
      "id": "campaign-uuid",
      "userId": "user-uuid",
      "name": "Nome da Campanha",
      "description": "Descrição da campanha",
      "status": "DRAFT",
      "messageTemplate": "Template da mensagem",
      "createdAt": "2025-01-15T10:00:00.000Z",
      "updatedAt": "2025-01-15T10:00:00.000Z"
    }
  ]
  ```
* **Error Responses:**
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `campaign.getById` (tRPC Query)

* **Purpose:** Retorna detalhes completos de uma campanha incluindo estatísticas.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `id` (string, UUID): ID da campanha.
* **Success Response (200 OK):**
  ```json
  {
    "id": "campaign-uuid",
    "userId": "user-uuid",
    "name": "Nome da Campanha",
    "description": "Descrição",
    "status": "ACTIVE",
    "messageTemplate": "Template da mensagem",
    "stats": {
      "totalSent": 1000,
      "totalDelivered": 950,
      "totalRead": 800,
      "totalReplied": 50
    },
    "createdAt": "2025-01-15T10:00:00.000Z",
    "updatedAt": "2025-01-15T10:00:00.000Z"
  }
  ```
* **Error Responses:**
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `403 FORBIDDEN`: Campanha não pertence ao usuário.
  * `404 NOT_FOUND`: Campanha não encontrada.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `campaign.create` (tRPC Mutation)

* **Purpose:** Cria uma nova campanha em status DRAFT.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "name": "Nome da Campanha",
    "description": "Descrição da campanha",
    "messageTemplate": "Template da mensagem com {{variável}}"
  }
  ```
* **Success Response (200 OK):**
  ```json
  {
    "id": "campaign-uuid",
    "userId": "user-uuid",
    "name": "Nome da Campanha",
    "description": "Descrição da campanha",
    "status": "DRAFT",
    "messageTemplate": "Template da mensagem",
    "createdAt": "2025-01-15T10:00:00.000Z",
    "updatedAt": "2025-01-15T10:00:00.000Z"
  }
  ```
* **Error Responses:**
  * `400 VALIDATION_ERROR`: Dados inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

---

### Mensagens (Messages)

#### `message.send` (tRPC Mutation)

* **Purpose:** Envia uma mensagem WhatsApp individual com proteção anti-ban.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "phoneNumber": "5511999999999",
    "message": "Mensagem personalizada",
    "campaignId": "campaign-uuid"
  }
  ```
* **Success Response (200 OK):**
  ```json
  {
    "success": true,
    "messageId": "message-uuid",
    "status": "QUEUED",
    "estimatedDelivery": "2025-01-15T10:05:00.000Z"
  }
  ```
* **Error Responses:**
  * `400 VALIDATION_ERROR`: Número de telefone inválido ou mensagem muito longa.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `429 TOO_MANY_REQUESTS`: Rate limit excedido (proteção anti-ban).
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `message.sendBulk` (tRPC Mutation)

* **Purpose:** Envia mensagens em massa para múltiplos contatos com proteção anti-ban.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "campaignId": "campaign-uuid",
    "contacts": [
      {
        "phoneNumber": "5511999999999",
        "variables": {
          "nome": "João",
          "produto": "Curso X"
        }
      }
    ]
  }
  ```
* **Success Response (200 OK):**
  ```json
  {
    "success": true,
    "jobId": "job-uuid",
    "totalContacts": 100,
    "estimatedCompletion": "2025-01-15T11:00:00.000Z"
  }
  ```
* **Error Responses:**
  * `400 VALIDATION_ERROR`: Dados inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `429 TOO_MANY_REQUESTS`: Rate limit excedido.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

---

### Message Intents (Operacional)

#### `GET /api/message-intents/:id`

* **Purpose:** Retorna detalhes do Message Intent para auditoria e UX operacional.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `id` (string, UUID): ID do intent.
* **Success Response (200 OK):**
 ```json
 {
   "intent": {
     "id": "intent-uuid",
     "organizationId": "org-uuid",
     "status": "APPROVED",
     "purpose": "DISPATCH",
     "origin": "CHAT_MANUAL",
     "type": "TEXT",
     "target": { "kind": "PHONE", "value": "5511999999999" },
     "decidedByInstanceId": "instance-uuid",
     "blockedReason": null,
     "queuedUntil": null,
     "createdAt": "2025-01-24T10:00:00.000Z",
     "payloadSummary": {
       "type": "TEXT",
       "textPreview": "Olá, sua mensagem..."
     }
   }
 }
 ```
* **Error Responses:**
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `404 NOT_FOUND`: Intent não encontrado.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `GET /api/execution-jobs?intentId=`

* **Purpose:** Lista execution jobs de um intent específico (control plane).
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `intentId` (string, UUID): ID do intent.
  * `status` (string, optional): PENDING | PROCESSING | SENT | FAILED | RETRY.
  * `limit` (number, optional): Máximo de itens (default 50).
* **Success Response (200 OK):**
 ```json
 {
   "items": [
     {
       "id": "job-uuid",
       "intentId": "intent-uuid",
       "instanceId": "instance-uuid",
       "provider": "whatsmeow",
       "status": "PROCESSING",
       "attempts": 1,
       "lastError": null,
       "createdAt": "2025-01-24T10:00:00.000Z",
       "executedAt": null,
       "nextAttemptAt": null
     }
   ]
 }
 ```
* **Error Responses:**
  * `400 BAD_REQUEST`: intentId ou status inválido.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `404 NOT_FOUND`: Intent não encontrado.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

---

### Message Intents

#### `GET /api/message-intents`

* **Purpose:** Lista Message Intents da organização com filtros simples.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `status` (string, optional): `PENDING | APPROVED | QUEUED | BLOCKED | DROPPED | SENT`.
  * `purpose` (string, optional): `WARMUP | DISPATCH | SCHEDULE`.
  * `instanceId` (string, optional): Filtra por instância que decidiu o intent.
  * `limit` (number, optional): Máximo de itens (1-200).
* **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "id": "intent-uuid",
        "target": { "kind": "PHONE", "value": "5511999999999" },
        "purpose": "DISPATCH",
        "origin": "CHAT_MANUAL",
        "status": "APPROVED",
        "decidedByInstanceId": "instance-uuid",
        "createdAt": "2026-01-24T10:00:00.000Z"
      }
    ]
  }
  ```
* **Error Responses:**
  * `400 BAD_REQUEST`: Parâmetros inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

### Conversas (Chat CRM)

#### `GET /api/conversations`

* **Purpose:** Lista conversas filtradas por instância e status.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `instanceId` (string, required): ID da instância.
  * `status` (string, optional): `OPEN | WAITING | CLOSED | LOST`.
  * `search` (string, optional): Termo para filtrar por contato.
  * `operatorId` (string, optional): Filtra por operador e fila.
  * `includeUnassigned` (boolean, optional): Inclui conversas sem operador (default true).
  * `limit` (number, optional): Máximo de itens (1-200).
  * `offset` (number, optional): Paginação por offset.
* **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "id": "conversation-uuid",
        "instanceId": "instance-uuid",
        "contactId": "5511999999999",
        "contactName": "Lead A",
        "status": "OPEN",
        "assignedAgentId": "agent-uuid",
        "assignedOperatorId": "operator-uuid",
        "unreadCount": 1,
        "lastMessageAt": "2026-01-24T10:00:00.000Z",
        "lastMessage": {
          "body": "Olá!",
          "direction": "INBOUND",
          "type": "TEXT",
          "sentBy": "CONTACT",
          "occurredAt": "2026-01-24T10:00:00.000Z"
        }
      }
    ],
    "total": 1
  }
  ```
* **Error Responses:**
  * `400 BAD_REQUEST`: Parâmetros inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

### Operadores (Chat CRM)

#### `GET /api/operators/me`

* **Purpose:** Retorna o operador associado ao usuário logado.
* **Authentication:** Better Auth session (usuário autenticado).
* **Success Response (200 OK):**
  ```json
  {
    "operator": {
      "id": "operator-uuid",
      "userId": "user-uuid",
      "name": "Operador A",
      "status": "ONLINE",
      "maxConcurrentConversations": 20,
      "currentConversationCount": 3
    }
  }
  ```
* **Error Responses:**
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `GET /api/operators`

* **Purpose:** Lista operadores disponíveis para assumir conversas.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `status` (string, optional): `ONLINE | AWAY | OFFLINE`.
  * `limit` (number, optional): Máximo de itens (1-200).
* **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "id": "operator-uuid",
        "userId": "user-uuid",
        "name": "Operador A",
        "status": "ONLINE",
        "maxConcurrentConversations": 20,
        "currentConversationCount": 3
      }
    ]
  }
  ```
* **Error Responses:**
  * `400 BAD_REQUEST`: Parâmetros inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `POST /api/operators/assign`

* **Purpose:** Atribui uma conversa a um operador.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "conversationId": "conversation-uuid",
    "operatorId": "operator-uuid"
  }
  ```
* **Success Response (204 NO CONTENT)**
* **Error Responses:**
  * `400 BAD_REQUEST`: Dados inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `404 NOT_FOUND`: Conversation ou operator não encontrados.
  * `409 CONFLICT`: Conversation já atribuída.
  * `409 CONFLICT`: Operador indisponível.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `POST /api/operators/release`

* **Purpose:** Libera a conversa do operador atual.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "conversationId": "conversation-uuid",
    "operatorId": "operator-uuid"
  }
  ```
* **Success Response (204 NO CONTENT)**
* **Error Responses:**
  * `400 BAD_REQUEST`: Dados inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `404 NOT_FOUND`: Conversation ou operator não encontrados.
  * `409 CONFLICT`: Operator não está atribuído.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `POST /api/operators/transfer`

* **Purpose:** Transfere a conversa entre operadores.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "conversationId": "conversation-uuid",
    "fromOperatorId": "operator-uuid",
    "toOperatorId": "operator-uuid"
  }
  ```
* **Success Response (204 NO CONTENT)**
* **Error Responses:**
  * `400 BAD_REQUEST`: Dados inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `404 NOT_FOUND`: Conversation ou operator não encontrados.
  * `409 CONFLICT`: Operator não está atribuído ou destino indisponível.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `GET /api/conversations/:id/messages`

* **Purpose:** Lista mensagens de uma conversa com conteúdo resolvido.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `id` (string, UUID): ID da conversa.
  * `limit` (number, optional): Máximo de itens (1-200).
  * `cursor` (string, optional): Paginação por cursor (message id).
* **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "id": "message-uuid",
        "direction": "INBOUND",
        "type": "TEXT",
        "sentBy": "CONTACT",
        "status": "SENT",
        "body": "Olá!",
        "occurredAt": "2026-01-24T10:00:00.000Z"
      }
    ],
    "nextCursor": "message-uuid"
  }
  ```
* **Error Responses:**
  * `400 BAD_REQUEST`: Parâmetros inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `404 NOT_FOUND`: Conversation não encontrada.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

### Realtime (WebSocket)

#### `GET /realtime` (WebSocket)

* **Purpose:** Entrega eventos em tempo real do Chat CRM para o frontend via WebSocket.
* **Authentication:** Better Auth session (cookie da sessão do usuário).
* **Client Message (subscribe):**
  ```json
  {
    "type": "subscribe",
    "instanceId": "instance-uuid",
    "organizationId": "org-uuid"
  }
  ```
* **Client Message (unsubscribe):**
  ```json
  {
    "type": "unsubscribe"
  }
  ```
* **Server Event (WebSocket message):**
  ```json
  {
    "type": "MESSAGE_RECEIVED",
    "payload": {
      "conversationId": "conversation-uuid",
      "instanceId": "instance-uuid",
      "message": {
        "id": "message-uuid",
        "direction": "INBOUND",
        "type": "TEXT",
        "sentBy": "CONTACT",
        "status": "SENT",
        "body": "Olá!",
        "occurredAt": "2026-01-24T10:00:00.000Z"
      }
    }
  }
  ```
* **Error Responses:**
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `403 FORBIDDEN`: Organização não autorizada.
  * `404 NOT_FOUND`: Instância não encontrada.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `POST /api/message-intents`

* **Purpose:** Cria um Message Intent manual para auditoria e controle operacional.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "target": { "kind": "PHONE", "value": "5511999999999" },
    "type": "TEXT",
    "purpose": "DISPATCH",
    "origin": "CHAT_MANUAL",
    "payload": { "type": "TEXT", "text": "Olá!" }
  }
  ```
* **Success Response (201 CREATED):**
  ```json
  {
    "intentId": "intent-uuid",
    "status": "PENDING"
  }
  ```
* **Error Responses:**
  * `400 BAD_REQUEST`: Dados inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

---

### Contas WhatsApp (WhatsApp Accounts)

#### `whatsapp.account.list` (tRPC Query)

* **Purpose:** Lista todas as contas WhatsApp do usuário.
* **Authentication:** Better Auth session (usuário autenticado).
* **Success Response (200 OK):**
  ```json
  [
    {
      "id": "account-uuid",
      "userId": "user-uuid",
      "phoneNumber": "5511999999999",
      "status": "CONNECTED",
      "warmupStatus": "ACTIVE",
      "warmupProgress": 75,
      "lastActivity": "2025-01-15T10:00:00.000Z"
    }
  ]
  ```
* **Error Responses:**
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

#### `whatsapp.account.startWarmup` (tRPC Mutation)

* **Purpose:** Inicia processo de aquecimento de uma conta WhatsApp.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Body (JSON):**
  ```json
  {
    "accountId": "account-uuid",
    "strategy": "STANDARD",
    "dailyLimit": 50
  }
  ```
* **Success Response (200 OK):**
  ```json
  {
    "success": true,
    "warmupId": "warmup-uuid",
    "estimatedDays": 7,
    "currentProgress": 0
  }
  ```
* **Error Responses:**
  * `400 VALIDATION_ERROR`: Dados inválidos.
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `403 FORBIDDEN`: Conta não pertence ao usuário.
  * `404 NOT_FOUND`: Conta não encontrada.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

---

### Analytics (Analytics)

#### `analytics.getCampaignStats` (tRPC Query)

* **Purpose:** Retorna estatísticas detalhadas de uma campanha.
* **Authentication:** Better Auth session (usuário autenticado).
* **Request Parameters (URL/Query):**
  * `campaignId` (string, UUID): ID da campanha.
  * `startDate` (string, ISO date, optional): Data inicial.
  * `endDate` (string, ISO date, optional): Data final.
* **Success Response (200 OK):**
  ```json
  {
    "campaignId": "campaign-uuid",
    "period": {
      "start": "2025-01-01T00:00:00.000Z",
      "end": "2025-01-15T23:59:59.000Z"
    },
    "stats": {
      "totalSent": 10000,
      "totalDelivered": 9500,
      "totalRead": 8000,
      "totalReplied": 500,
      "deliveryRate": 95.0,
      "readRate": 84.2,
      "replyRate": 5.3
    },
    "dailyBreakdown": [
      {
        "date": "2025-01-15",
        "sent": 500,
        "delivered": 475,
        "read": 400,
        "replied": 25
      }
    ]
  }
  ```
* **Error Responses:**
  * `401 UNAUTHORIZED`: Sessão inválida ou ausente.
  * `403 FORBIDDEN`: Campanha não pertence ao usuário.
  * `404 NOT_FOUND`: Campanha não encontrada.
  * `500 INTERNAL_ERROR`: Erro interno do servidor.

---

## Related Rules

- `@memory.mdc`: Mandates consultation and updates to this file.
- `@project-rules-enhanced.mdc`: Defines standards for creating API endpoints.

## Suggested Metadata
---
description: Central documentation for all WhatLead API endpoints (tRPC).
globs: ["packages/api/src/routers/**/*.ts", "apps/server/src/routers/**/*.ts"]
alwaysApply: false
---
